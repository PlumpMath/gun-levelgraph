{"version":3,"sources":["to-jsonld.js"],"names":["createToLdGraph","toLdGraph","toJsonLd","isRootNode","opts","visited","ids","length","defaultLogger","log","logging","args","defaultGraphId","id","logger","graphId","node","val","$val","_","jsonld","context","schemaUrl","soul","ldGraphId","indexOf","push","fullPath","path","parse","field","fieldNode","parentNode","fields","$fields","nodePaths","paths","concat","uniqFields","Set","filter","result","json","JSON","stringify","spacer","chain","$toJsonLd"],"mappings":"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","file":"to-jsonld.js","sourcesContent":["import Gun from 'gun/gun'\n\nfunction isRootNode(opts) {\n  return !opts.visited || opts.visited.ids.length === 0\n}\n\nfunction defaultLogger(opts) {\n  return function log(...args) {\n    if (opts.logging) {\n      console.log('toLdGraph:', ...args)\n    }\n  }\n}\n\nlet defaultGraphId = (id) => '#' + id\n\nlet log\n\nexport function createToLdGraph(opts) {\n  let logger = opts.logger || defaultLogger\n  log = logger(opts)\n  defaultGraphId = opts.graphId || defaultGraphId\n  return {\n    toLdGraph,\n    toJsonLd\n  }\n}\n\nexport async function toLdGraph(node, opts = {}) {\n  log = opts.log || log\n\n  let val = await node.$val()\n  if (!val._) {\n    log('field', val)\n    return val\n  }\n\n  let jsonld = {}\n\n  // if root node\n  if (isRootNode(opts)) {\n    let context = opts.schemaUrl || 'http://schema.org/'\n    log('root node:', context)\n    jsonld['@context'] = context\n  }\n\n  let soul = Gun.node.soul(val)\n  log('node id:', soul)\n\n  let ldGraphId = opts.graphId || defaultGraphId\n  let id = ldGraphId(soul, opts)\n  jsonld['@id'] = id\n\n  opts.visited = opts.visited || {\n    ids: []\n  }\n\n  if (opts.visited.ids.indexOf(id) >= 0) {\n    log('already visited:', jsonld)\n    return jsonld\n  }\n\n  opts.visited.ids.push(id)\n  let fullPath = (opts.path || '') + '/' + id\n  delete opts['paths']\n\n  // TODO: refactor\n  async function parse(field, node) {\n    log('recurse', field)\n    let fieldNode = node.path(field)\n    opts.path = fullPath + '/' + field\n    opts.parentNode = node\n    return await toLdGraph(fieldNode, opts)\n  }\n\n  let fields = await node.$fields()\n  let nodePaths = opts.paths || []\n  nodePaths = nodePaths.concat(node._.paths || [])\n\n  if (nodePaths) {\n    fields = fields.concat(nodePaths)\n  }\n\n  let uniqFields = [...new Set(fields)]\n\n  if (opts.filter) {\n    uniqFields = filter(uniqFields)\n  }\n\n  log('parse fields', uniqFields)\n  for (let field of uniqFields) {\n    jsonld[field] = await parse(field, node)\n  }\n\n  log('jsonld:', jsonld)\n  return jsonld\n}\n\nexport async function toJsonLd(node, opts = {}) {\n  let result = await toLdGraph(node, opts = {})\n  return {\n    result,\n    json: JSON.stringify(result, null, opts.spacer || 2)\n  }\n}\n\nGun.chain.$toJsonLd = async function (opts) {\n  return await toJsonLd(this, opts)\n}"]}